<!DOCTYPE html>
<!-- Generated by pkgdown: do not edit by hand --><html lang="en">
<head>
<meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
<meta charset="utf-8">
<meta http-equiv="X-UA-Compatible" content="IE=edge">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Exploring temporal trends • learningtower</title>
<!-- favicons --><link rel="icon" type="image/png" sizes="16x16" href="../favicon-16x16.png">
<link rel="icon" type="image/png" sizes="32x32" href="../favicon-32x32.png">
<link rel="apple-touch-icon" type="image/png" sizes="180x180" href="../apple-touch-icon.png">
<link rel="apple-touch-icon" type="image/png" sizes="120x120" href="../apple-touch-icon-120x120.png">
<link rel="apple-touch-icon" type="image/png" sizes="76x76" href="../apple-touch-icon-76x76.png">
<link rel="apple-touch-icon" type="image/png" sizes="60x60" href="../apple-touch-icon-60x60.png">
<!-- jquery --><script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.4.1/jquery.min.js" integrity="sha256-CSXorXvZcTkaix6Yvo6HppcZGetbYMGWSFlBw8HfCJo=" crossorigin="anonymous"></script><!-- Bootstrap --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/css/bootstrap.min.css" integrity="sha256-bZLfwXAP04zRMK2BjiO8iu9pf4FbLqX6zitd+tIvLhE=" crossorigin="anonymous">
<script src="https://cdnjs.cloudflare.com/ajax/libs/twitter-bootstrap/3.4.1/js/bootstrap.min.js" integrity="sha256-nuL8/2cJ5NDSSwnKD8VqreErSWHtnEP9E7AySL+1ev4=" crossorigin="anonymous"></script><!-- bootstrap-toc --><link rel="stylesheet" href="../bootstrap-toc.css">
<script src="../bootstrap-toc.js"></script><!-- Font Awesome icons --><link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/all.min.css" integrity="sha256-mmgLkCYLUQbXn0B1SRqzHar6dCnv9oZFPEC1g1cwlkk=" crossorigin="anonymous">
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.12.1/css/v4-shims.min.css" integrity="sha256-wZjR52fzng1pJHwx4aV2AO3yyTOXrcDW7jBpJtTwVxw=" crossorigin="anonymous">
<!-- clipboard.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/clipboard.js/2.0.6/clipboard.min.js" integrity="sha256-inc5kl9MA1hkeYUt+EC3BhlIgyp/2jDIyBLS6k3UxPI=" crossorigin="anonymous"></script><!-- headroom.js --><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/headroom.min.js" integrity="sha256-AsUX4SJE1+yuDu5+mAVzJbuYNPHj/WroHuZ8Ir/CkE0=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/headroom/0.11.0/jQuery.headroom.min.js" integrity="sha256-ZX/yNShbjqsohH1k95liqY9Gd8uOiE1S4vZc+9KQ1K4=" crossorigin="anonymous"></script><!-- pkgdown --><link href="../pkgdown.css" rel="stylesheet">
<script src="../pkgdown.js"></script><meta property="og:title" content="Exploring temporal trends">
<meta property="og:description" content="learningtower">
<meta property="og:image" content="https://ropenscilabs.github.io/learningtower/logo.png">
<!-- mathjax --><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/MathJax.js" integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/mathjax/2.7.5/config/TeX-AMS-MML_HTMLorMML.js" integrity="sha256-84DKXVJXs0/F8OTMzX4UR909+jtl4G7SPypPavF+GfA=" crossorigin="anonymous"></script><!--[if lt IE 9]>
<script src="https://oss.maxcdn.com/html5shiv/3.7.3/html5shiv.min.js"></script>
<script src="https://oss.maxcdn.com/respond/1.4.2/respond.min.js"></script>
<![endif]-->
</head>
<body data-spy="scroll" data-target="#toc">
    <div class="container template-article">
      <header><div class="navbar navbar-default navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar" aria-expanded="false">
        <span class="sr-only">Toggle navigation</span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <span class="navbar-brand">
        <a class="navbar-link" href="../index.html">learningtower</a>
        <span class="version label label-default" data-toggle="tooltip" data-placement="bottom" title="Released version">0.0.0.9000</span>
      </span>
    </div>

    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
<li>
  <a href="../index.html">
    <span class="fas fa fas fa-home fa-lg"></span>
     
  </a>
</li>
<li>
  <a href="../reference/index.html">Reference</a>
</li>
<li class="dropdown">
  <a href="#" class="dropdown-toggle" data-toggle="dropdown" role="button" aria-expanded="false">
    Articles
     
    <span class="caret"></span>
  </a>
  <ul class="dropdown-menu" role="menu">
<li>
      <a href="../articles/exploring_time.html">Exploring temporal trends</a>
    </li>
    <li>
      <a href="../articles/visualise_distribution.html">Visualise differential distribution between countries</a>
    </li>
  </ul>
</li>
      </ul>
<ul class="nav navbar-nav navbar-right"></ul>
</div>
<!--/.nav-collapse -->
  </div>
<!--/.container -->
</div>
<!--/.navbar -->

      

      </header><div class="row">
  <div class="col-md-9 contents">
    <div class="page-header toc-ignore">
      <h1 data-toc-skip>Exploring temporal trends</h1>
                        <h4 class="author">The Freemasons</h4>
            
            <h4 class="date">2020-06-05</h4>
      
      
      <div class="hidden name"><code>exploring_time.Rmd</code></div>

    </div>

    
    
<div id="loading-packages-and-data" class="section level1">
<h1 class="hasAnchor">
<a href="#loading-packages-and-data" class="anchor"></a>Loading packages and data</h1>
<div class="sourceCode" id="cb1"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">learningtower</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tidyverse</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">patchwork</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">brolgar</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">gghighlight</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">ggrepel</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">brolgar</span>)
<span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">tsibble</span>)

<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="no">student</span>)
<span class="fu"><a href="https://rdrr.io/r/utils/data.html">data</a></span>(<span class="no">countrycode</span>)
<span class="fu">theme_set</span>(<span class="fu">theme_classic</span>(<span class="fl">18</span>) +
            <span class="fu">theme</span>(<span class="kw">legend.position</span> <span class="kw">=</span> <span class="st">"bottom"</span>))</pre></body></html></div>
</div>
<div id="time-series-visualisation" class="section level1">
<h1 class="hasAnchor">
<a href="#time-series-visualisation" class="anchor"></a>Time series visualisation</h1>
<p>We will first visualise the time series trend of countries, regardless of when and how long they have participated in the PISA study.</p>
<div class="sourceCode" id="cb2"><html><body><pre class="r"><span class="no">w_mean</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">x</span>, <span class="no">w</span>){<span class="fu"><a href="https://rdrr.io/r/stats/weighted.mean.html">weighted.mean</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">x</span>, <span class="kw">w</span> <span class="kw">=</span> <span class="no">w</span>, <span class="kw">na.rm</span><span class="kw">=</span><span class="fl">TRUE</span>)}

<span class="no">stu_summ</span> <span class="kw">=</span> <span class="no">student</span> <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">year</span>, <span class="no">country</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarise_at</span>(<span class="kw">.vars</span> <span class="kw">=</span> <span class="fu">vars</span>(<span class="no">math</span>, <span class="no">read</span>, <span class="no">science</span>),
               <span class="kw">.funs</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">wmean</span> <span class="kw">=</span> ~<span class="fu">w_mean</span>(<span class="no">.</span>, <span class="kw">w</span> <span class="kw">=</span> <span class="no">stu_wgt</span>),
                            <span class="kw">min</span> <span class="kw">=</span> ~<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">.</span>, <span class="kw">na.rm</span> <span class="kw">=</span> <span class="fl">TRUE</span>),
                            <span class="kw">max</span> <span class="kw">=</span> ~<span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">max</a></span>(<span class="no">.</span>, <span class="kw">na.rm</span> <span class="kw">=</span> <span class="fl">TRUE</span>))) <span class="kw">%&gt;%</span>
  <span class="fu">ungroup</span>() <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">year</span> <span class="kw">=</span> <span class="no">year</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>() <span class="kw">%&gt;%</span> <span class="no">as.integer</span>)


<span class="no">stu_wmean_long</span> <span class="kw">=</span> <span class="no">stu_summ</span> <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(<span class="no">year</span>, <span class="no">country</span>, <span class="fu">contains</span>(<span class="st">"wmean"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="fu">contains</span>(<span class="st">"wmean"</span>),
               <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">"wmean_names"</span>,
               <span class="kw">values_to</span> <span class="kw">=</span> <span class="st">"wmean_values"</span>)

<span class="no">stu_wmean_long</span> <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu"><a href="https://rdrr.io/pkg/gghighlight/man/reexports.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">year</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">wmean_values</span>, <span class="kw">group</span> <span class="kw">=</span> <span class="no">country</span>)) +
  <span class="fu">geom_line</span>() +
  <span class="fu">facet_wrap</span>(~<span class="no">wmean_names</span>) +
  <span class="fu">labs</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"Year"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Weighted mean values"</span>)</pre></body></html></div>
<p><img src="exploring_time_files/figure-html/unnamed-chunk-2-1.png" width="768"></p>
<div class="sourceCode" id="cb3"><html><body><pre class="r">

<span class="co">## Uncomment this to make interactive</span>
<span class="co"># library(plotly)</span>
<span class="co"># ggplotly()</span></pre></body></html></div>
<div id="australia-new-zealand-indonesia" class="section level2">
<h2 class="hasAnchor">
<a href="#australia-new-zealand-indonesia" class="anchor"></a>Australia, New Zealand, Indonesia</h2>
<p>We focus on three countries here. The dark line is the weighted mean score of each country for each subject. The shading indicates the min and max score of a given year.</p>
<div class="sourceCode" id="cb4"><html><body><pre class="r"><span class="no">stu_summ_long2</span> <span class="kw">=</span> <span class="no">stu_summ</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">country</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"AUS"</span>, <span class="st">"NZL"</span>, <span class="st">"IDN"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="no">math_wmean</span>:<span class="no">science_max</span>,
               <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">"names"</span>,
               <span class="kw">values_to</span> <span class="kw">=</span> <span class="st">"values"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">separate</span>(<span class="kw">col</span> <span class="kw">=</span> <span class="no">names</span>, <span class="kw">into</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"subject"</span>, <span class="st">"statistics"</span>), <span class="kw">sep</span> <span class="kw">=</span> <span class="st">"_"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_wider</span>(<span class="kw">names_from</span> <span class="kw">=</span> <span class="st">"statistics"</span>,
              <span class="kw">values_from</span> <span class="kw">=</span> <span class="st">"values"</span>)
<span class="no">stu_summ_long2</span>
<span class="co">#&gt; # A tibble: 63 x 6</span>
<span class="co">#&gt;     year country subject wmean   min   max</span>
<span class="co">#&gt;    &lt;int&gt; &lt;fct&gt;   &lt;chr&gt;   &lt;dbl&gt; &lt;dbl&gt; &lt;dbl&gt;</span>
<span class="co">#&gt;  1  2000 AUS     math     530. 211.   784.</span>
<span class="co">#&gt;  2  2000 AUS     read     529. 159    828.</span>
<span class="co">#&gt;  3  2000 AUS     science  527. 167.   800.</span>
<span class="co">#&gt;  4  2000 IDN     math     371.  88.5  646.</span>
<span class="co">#&gt;  5  2000 IDN     read     376.  93.3  610.</span>
<span class="co">#&gt;  6  2000 IDN     science  394.  84.4  680.</span>
<span class="co">#&gt;  7  2000 NZL     math     537. 195.   796.</span>
<span class="co">#&gt;  8  2000 NZL     read     529. 134.   834.</span>
<span class="co">#&gt;  9  2000 NZL     science  528. 169.   830.</span>
<span class="co">#&gt; 10  2003 AUS     math     524. 161.   833.</span>
<span class="co">#&gt; # … with 53 more rows</span>


<span class="no">stu_summ_long2</span> <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu"><a href="https://rdrr.io/pkg/gghighlight/man/reexports.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">year</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">wmean</span>)) +
  <span class="fu">geom_ribbon</span>(<span class="fu"><a href="https://rdrr.io/pkg/gghighlight/man/reexports.html">aes</a></span>(<span class="kw">ymin</span> <span class="kw">=</span> <span class="no">min</span>, <span class="kw">ymax</span> <span class="kw">=</span> <span class="no">max</span>), <span class="kw">fill</span> <span class="kw">=</span> <span class="st">"grey70"</span>) +
  <span class="fu">geom_line</span>(<span class="kw">colour</span> <span class="kw">=</span> <span class="st">"black"</span>, <span class="kw">size</span> <span class="kw">=</span> <span class="fl">2</span>) +
  <span class="fu">facet_grid</span>(<span class="no">subject</span>~<span class="no">country</span>, <span class="kw">labeller</span> <span class="kw">=</span> <span class="no">label_both</span>) +
  <span class="fu">labs</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"Year"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Test score values"</span>)</pre></body></html></div>
<p><img src="exploring_time_files/figure-html/unnamed-chunk-3-1.png" width="768"></p>
</div>
</div>
<div id="brolgar-visualisations" class="section level1">
<h1 class="hasAnchor">
<a href="#brolgar-visualisations" class="anchor"></a><code>brolgar</code> visualisations</h1>
<div id="calculating-slope" class="section level2">
<h2 class="hasAnchor">
<a href="#calculating-slope" class="anchor"></a>Calculating slope</h2>
<p>There are many countries/regions who did not participate in all 7 PISA countries. As we are interested in calculating linear models, we will retain only those countries/regions participated in 5 or more studies.</p>
<div class="sourceCode" id="cb5"><html><body><pre class="r"><span class="no">complete_nations</span> <span class="kw">=</span> <span class="no">stu_summ</span> <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">country</span>) <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="fu">n</span>() <span class="kw">&gt;=</span> <span class="fl">5</span>) <span class="kw">%&gt;%</span>
  <span class="fu">ungroup</span>() <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">year_subtract</span> <span class="kw">=</span> <span class="no">year</span> - <span class="fu"><a href="https://rdrr.io/r/base/Extremes.html">min</a></span>(<span class="no">year</span>)) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brolgar/man/reexports.html">as_tsibble</a></span>(<span class="kw">key</span> <span class="kw">=</span> <span class="no">country</span>, <span class="kw">index</span> <span class="kw">=</span> <span class="no">year_subtract</span>)

<span class="no">math_slope</span> <span class="kw">=</span> <span class="no">complete_nations</span> <span class="kw">%&gt;%</span> <span class="co">## Filter for countries participated in all 7 PISA studies</span>
  <span class="fu">select</span>(
    <span class="no">year_subtract</span>,
    <span class="no">country</span>,
    <span class="no">math_wmean</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brolgar/man/key_slope.html">key_slope</a></span>(<span class="no">math_wmean</span> ~ <span class="no">year_subtract</span>) <span class="kw">%&gt;%</span>
  <span class="fu">left_join</span>(<span class="no">countrycode</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="st">"country"</span>)

<span class="no">math_slope</span> <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu"><a href="https://rdrr.io/pkg/gghighlight/man/reexports.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">.intercept</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">.slope_year_subtract</span>)) +
  <span class="fu">geom_point</span>() +
  <span class="fu"><a href="https://rdrr.io/pkg/ggrepel/man/geom_text_repel.html">geom_text_repel</a></span>(<span class="fu"><a href="https://rdrr.io/pkg/gghighlight/man/reexports.html">aes</a></span>(<span class="kw">label</span> <span class="kw">=</span> <span class="no">country_name</span>), <span class="kw">size</span> <span class="kw">=</span> <span class="fl">3</span>) +
  <span class="fu">geom_hline</span>(<span class="kw">yintercept</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">colour</span> <span class="kw">=</span> <span class="st">"red"</span>) +
  <span class="fu">labs</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"Weighted mean math score in first participation"</span>,
       <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Avg. increase in weighted mean score every year"</span>) +
  <span class="fu">scale_y_continuous</span>(<span class="kw">limits</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(-<span class="fl">8</span>, <span class="fl">8</span>))</pre></body></html></div>
<p><img src="exploring_time_files/figure-html/unnamed-chunk-4-1.png" width="768"></p>
<div class="sourceCode" id="cb6"><html><body><pre class="r">

<span class="no">math_slope_near</span> <span class="kw">&lt;-</span> <span class="no">math_slope</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brolgar/man/keys_near.html">keys_near</a></span>(<span class="kw">key</span> <span class="kw">=</span> <span class="no">country</span>, <span class="kw">var</span> <span class="kw">=</span> <span class="no">.slope_year_subtract</span>)

<span class="no">math_slope_near</span>
<span class="co">#&gt; # A tibble: 5 x 5</span>
<span class="co">#&gt;   country .slope_year_subtract stat  stat_value stat_diff</span>
<span class="co">#&gt;   &lt;chr&gt;                  &lt;dbl&gt; &lt;fct&gt;      &lt;dbl&gt;     &lt;dbl&gt;</span>
<span class="co">#&gt; 1 NZL                   -2.48  min       -2.48     0     </span>
<span class="co">#&gt; 2 USA                   -0.816 q_25      -0.797    0.0187</span>
<span class="co">#&gt; 3 GRC                    0.107 med        0.172    0.0641</span>
<span class="co">#&gt; 4 TUR                    1.35  q_75       1.32     0.0336</span>
<span class="co">#&gt; 5 QAT                    7.59  max        7.59     0</span></pre></body></html></div>
</div>
<div id="highlighting-monotone-countries-for-subjects" class="section level2">
<h2 class="hasAnchor">
<a href="#highlighting-monotone-countries-for-subjects" class="anchor"></a>Highlighting monotone countries for subjects</h2>
<div class="sourceCode" id="cb7"><html><body><pre class="r"><span class="co"># math_features &lt;- complete_nations %&gt;% </span>
<span class="co">#   features(math_wmean, feat_brolgar)</span>
<span class="co"># </span>
<span class="co"># math_features</span>

<span class="no">feature_monotone</span> <span class="kw">=</span> <span class="no">complete_nations</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brolgar/man/reexports.html">features_at</a></span>(<span class="kw">.var</span> <span class="kw">=</span> <span class="fu">vars</span>(<span class="no">math_wmean</span>, <span class="no">read_wmean</span>, <span class="no">science_wmean</span>),
              <span class="kw">features</span> <span class="kw">=</span> <span class="no">feat_monotonic</span>) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/select.html">select</a></span>(<span class="no">country</span>, <span class="fu">contains</span>(<span class="st">"increase"</span>), <span class="fu">contains</span>(<span class="st">"decrease"</span>))

<span class="no">feature_monotone_long</span> <span class="kw">=</span> <span class="no">feature_monotone</span> <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> -<span class="no">country</span>,
               <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">"names"</span>,
               <span class="kw">values_to</span> <span class="kw">=</span> <span class="st">"monotone_value"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">separate</span>(<span class="kw">col</span> <span class="kw">=</span> <span class="no">names</span>, <span class="kw">into</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"subject"</span>, <span class="st">"direction"</span>), <span class="kw">sep</span> <span class="kw">=</span> <span class="st">"_(?!.*_)"</span>)

<span class="no">plot_tbl</span> <span class="kw">=</span> <span class="no">complete_nations</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://tsibble.tidyverts.org/reference/reexports.html">as_tibble</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(<span class="no">year</span>, <span class="no">country</span>, <span class="no">math_wmean</span>, <span class="no">read_wmean</span>, <span class="no">science_wmean</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="fu">contains</span>(<span class="st">"_wmean"</span>),
               <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">"subject"</span>,
               <span class="kw">values_to</span> <span class="kw">=</span> <span class="st">"wmean_value"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">left_join</span>(<span class="no">feature_monotone_long</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"country"</span>, <span class="st">"subject"</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">left_join</span>(<span class="no">countrycode</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="st">"country"</span>)

<span class="no">plot_tbl</span>
<span class="co">#&gt; # A tibble: 2,130 x 7</span>
<span class="co">#&gt;     year country subject       wmean_value direction monotone_value country_name</span>
<span class="co">#&gt;    &lt;int&gt; &lt;chr&gt;   &lt;chr&gt;               &lt;dbl&gt; &lt;chr&gt;     &lt;lgl&gt;          &lt;chr&gt;       </span>
<span class="co">#&gt;  1  2000 ALB     math_wmean           395. increase  FALSE          Albania     </span>
<span class="co">#&gt;  2  2000 ALB     math_wmean           395. decrease  FALSE          Albania     </span>
<span class="co">#&gt;  3  2000 ALB     read_wmean           354. increase  TRUE           Albania     </span>
<span class="co">#&gt;  4  2000 ALB     read_wmean           354. decrease  FALSE          Albania     </span>
<span class="co">#&gt;  5  2000 ALB     science_wmean        378. increase  FALSE          Albania     </span>
<span class="co">#&gt;  6  2000 ALB     science_wmean        378. decrease  FALSE          Albania     </span>
<span class="co">#&gt;  7  2009 ALB     math_wmean           377. increase  FALSE          Albania     </span>
<span class="co">#&gt;  8  2009 ALB     math_wmean           377. decrease  FALSE          Albania     </span>
<span class="co">#&gt;  9  2009 ALB     read_wmean           385. increase  TRUE           Albania     </span>
<span class="co">#&gt; 10  2009 ALB     read_wmean           385. decrease  FALSE          Albania     </span>
<span class="co">#&gt; # … with 2,120 more rows</span>

<span class="no">plot_tbl</span> <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu"><a href="https://rdrr.io/pkg/gghighlight/man/reexports.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">year</span>,
             <span class="kw">y</span> <span class="kw">=</span> <span class="no">wmean_value</span>,
             <span class="kw">group</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/interaction.html">interaction</a></span>(<span class="no">country</span>, <span class="no">subject</span>))) +
  <span class="fu">geom_line</span>() +
  <span class="kw pkg">gghighlight</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/gghighlight/man/gghighlight.html">gghighlight</a></span>(<span class="no">monotone_value</span>, <span class="kw">label_key</span> <span class="kw">=</span> <span class="no">country_name</span>) +
  <span class="fu">facet_grid</span>(<span class="no">direction</span>~<span class="no">subject</span>) +
  <span class="fu">labs</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"Year"</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="st">"Weighted means"</span>)</pre></body></html></div>
<p><img src="exploring_time_files/figure-html/unnamed-chunk-5-1.png" width="768"></p>
</div>
<div id="highlighting-variance" class="section level2">
<h2 class="hasAnchor">
<a href="#highlighting-variance" class="anchor"></a>Highlighting variance</h2>
<p>We will use three measures of variability (standard deviation, coefficient of variation, quartile coefficient of dispersion) to visualise the general movements of countries over time. But we will use coefficient of variation as the final visualisation.</p>
<div class="sourceCode" id="cb8"><html><body><pre class="r"><span class="no">student</span> <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">year</span>, <span class="no">country</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarise_at</span>(
    <span class="kw">.vars</span> <span class="kw">=</span> <span class="fu">vars</span>(<span class="no">math</span>, <span class="no">read</span>, <span class="no">science</span>),
    <span class="kw">.funs</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
      <span class="kw">mean</span> <span class="kw">=</span> ~ <span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">.</span>, <span class="kw">na.rm</span> <span class="kw">=</span> <span class="fl">TRUE</span>),
      <span class="kw">sd</span> <span class="kw">=</span> ~ <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span>(<span class="no">.</span>, <span class="kw">na.rm</span> <span class="kw">=</span> <span class="fl">TRUE</span>))) <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu"><a href="https://rdrr.io/pkg/gghighlight/man/reexports.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">math_mean</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">math_sd</span>, <span class="kw">colour</span> <span class="kw">=</span> <span class="no">year</span>)) +
  <span class="fu">geom_point</span>() +
  <span class="fu">scale_colour_brewer</span>(<span class="kw">palette</span> <span class="kw">=</span> <span class="st">"Dark2"</span>) +
  <span class="fu">labs</span>(<span class="kw">x</span> <span class="kw">=</span> <span class="st">"Mean maths score"</span>,
       <span class="kw">y</span> <span class="kw">=</span> <span class="st">"SD maths score"</span>)</pre></body></html></div>
<p><img src="exploring_time_files/figure-html/unnamed-chunk-6-1.png" width="768"></p>
<div class="sourceCode" id="cb9"><html><body><pre class="r">
<span class="no">qcd</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">x</span>){
  <span class="no">q3</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">x</span>, <span class="fl">0.75</span>, <span class="kw">na.rm</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
  <span class="no">q1</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/stats/quantile.html">quantile</a></span>(<span class="no">x</span>, <span class="fl">0.25</span>, <span class="kw">na.rm</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
  <span class="fu"><a href="https://rdrr.io/r/base/function.html">return</a></span>((<span class="no">q3</span>-<span class="no">q1</span>)/(<span class="no">q3</span>+<span class="no">q1</span>))
}

<span class="no">cv</span> <span class="kw">=</span> <span class="kw">function</span>(<span class="no">x</span>){
  <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span>(<span class="no">x</span>, <span class="kw">na.rm</span> <span class="kw">=</span> <span class="fl">TRUE</span>)/<span class="fu"><a href="https://rdrr.io/r/base/mean.html">mean</a></span>(<span class="no">x</span>, <span class="kw">na.rm</span> <span class="kw">=</span> <span class="fl">TRUE</span>)
}

<span class="no">stu_var_summ</span> <span class="kw">=</span> <span class="no">student</span> <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">year</span>, <span class="no">country</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarise_at</span>(
    <span class="kw">.vars</span> <span class="kw">=</span> <span class="fu">vars</span>(<span class="no">math</span>, <span class="no">read</span>, <span class="no">science</span>),
    <span class="kw">.funs</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(
      <span class="kw">sd</span> <span class="kw">=</span> ~ <span class="fu"><a href="https://rdrr.io/r/stats/sd.html">sd</a></span>(<span class="no">.</span>, <span class="kw">na.rm</span> <span class="kw">=</span> <span class="fl">TRUE</span>),
      <span class="kw">qcd</span> <span class="kw">=</span> ~ <span class="fu">qcd</span>(<span class="no">.</span>),
      <span class="kw">cv</span> <span class="kw">=</span> ~ <span class="fu">cv</span>(<span class="no">.</span>))) <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">mutate</a></span>(<span class="kw">year</span> <span class="kw">=</span> <span class="no">year</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>() <span class="kw">%&gt;%</span> <span class="no">as.integer</span>) <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">country</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="fu">n</span>() <span class="kw">&gt;=</span> <span class="fl">5</span>) <span class="kw">%&gt;%</span>
  <span class="fu">ungroup</span>()


<span class="no">stu_var_summ_long</span> <span class="kw">=</span> <span class="no">stu_var_summ</span> <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> -<span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"year"</span>, <span class="st">"country"</span>),
               <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">"names"</span>,
               <span class="kw">values_to</span> <span class="kw">=</span> <span class="st">"values"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">separate</span>(<span class="kw">col</span> <span class="kw">=</span> <span class="st">"names"</span>, <span class="kw">into</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"subject"</span>, <span class="st">"statistic"</span>), <span class="kw">sep</span> <span class="kw">=</span> <span class="st">"_"</span>)

<span class="no">stu_var_summ_long</span> <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu"><a href="https://rdrr.io/pkg/gghighlight/man/reexports.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">year</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">values</span>,
             <span class="kw">group</span> <span class="kw">=</span> <span class="no">country</span>)) +
  <span class="fu">geom_line</span>() +
  <span class="fu">facet_grid</span>(<span class="no">statistic</span>~<span class="no">subject</span>, <span class="kw">scales</span> <span class="kw">=</span> <span class="st">"free_y"</span>)</pre></body></html></div>
<p><img src="exploring_time_files/figure-html/unnamed-chunk-6-2.png" width="768"></p>
<div class="sourceCode" id="cb10"><html><body><pre class="r">
<span class="no">stu_var_summ</span> <span class="kw">=</span> <span class="no">stu_var_summ</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brolgar/man/reexports.html">as_tsibble</a></span>(<span class="kw">key</span> <span class="kw">=</span> <span class="no">country</span>, <span class="kw">index</span> <span class="kw">=</span> <span class="no">year</span>)

<span class="no">stu_var_near</span> <span class="kw">=</span> <span class="no">stu_var_summ</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brolgar/man/reexports.html">features</a></span>(<span class="no">math_cv</span>, <span class="no">feat_brolgar</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brolgar/man/keys_near.html">keys_near</a></span>(<span class="kw">key</span> <span class="kw">=</span> <span class="no">country</span>, <span class="kw">var</span> <span class="kw">=</span> <span class="no">median</span>)

<span class="no">stu_var_near</span>
<span class="co">#&gt; # A tibble: 6 x 5</span>
<span class="co">#&gt;   country median stat  stat_value stat_diff</span>
<span class="co">#&gt;   &lt;fct&gt;    &lt;dbl&gt; &lt;fct&gt;      &lt;dbl&gt;     &lt;dbl&gt;</span>
<span class="co">#&gt; 1 FIN      0.153 min        0.153  0       </span>
<span class="co">#&gt; 2 ISL      0.178 q_25       0.178  0.000122</span>
<span class="co">#&gt; 3 AUS      0.187 med        0.187  0.000772</span>
<span class="co">#&gt; 4 HUN      0.188 med        0.187  0.000772</span>
<span class="co">#&gt; 5 IDN      0.202 q_75       0.201  0.00110 </span>
<span class="co">#&gt; 6 QAT      0.263 max        0.263  0</span>

<span class="no">stu_var_plotdf</span> <span class="kw">=</span> <span class="no">stu_var_summ_long</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">subject</span> <span class="kw">==</span> <span class="st">"math"</span>, <span class="no">statistic</span> <span class="kw">==</span> <span class="st">"cv"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">left_join</span>(<span class="no">stu_var_near</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="st">"country"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">left_join</span>(<span class="no">countrycode</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="st">"country"</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://tsibble.tidyverts.org/reference/reexports.html">as_tibble</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">label_stats_country</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">stat</span>), <span class="fl">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">stat</span>, <span class="st">":"</span>, <span class="no">country_name</span>)))

<span class="no">stu_var_plotdf</span> <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu"><a href="https://rdrr.io/pkg/gghighlight/man/reexports.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">year</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">values</span>,
             <span class="kw">group</span> <span class="kw">=</span> <span class="no">country</span>, <span class="kw">colour</span> <span class="kw">=</span> <span class="no">stat</span>)) +
  <span class="fu">geom_line</span>() +
  <span class="kw pkg">gghighlight</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/gghighlight/man/gghighlight.html">gghighlight</a></span>(!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">stat</span>), <span class="kw">label_key</span> <span class="kw">=</span> <span class="no">label_stats_country</span>) +
  <span class="fu">labs</span>(<span class="kw">y</span> <span class="kw">=</span> <span class="st">"Coef. of variation across students"</span>)</pre></body></html></div>
<p><img src="exploring_time_files/figure-html/unnamed-chunk-6-3.png" width="768"></p>
</div>
<div id="gender-gap-over-time" class="section level2">
<h2 class="hasAnchor">
<a href="#gender-gap-over-time" class="anchor"></a>Gender gap over time</h2>
<p>Though not perfect measures, we will look at the differences in the average test scores for each gender.</p>
<p>In maths, there are more countries with a higher average for the boys. In reading, the girls completely dominates in every country. Science is more evenly spilt.</p>
<div class="sourceCode" id="cb11"><html><body><pre class="r"><span class="no">stu_gender_summ</span> <span class="kw">=</span> <span class="no">student</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="fu"><a href="https://rdrr.io/r/stats/complete.cases.html">complete.cases</a></span>(<span class="no">gender</span>)) <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">year</span>, <span class="no">country</span>, <span class="no">gender</span>) <span class="kw">%&gt;%</span>
  <span class="fu">summarise_at</span>(<span class="kw">.vars</span> <span class="kw">=</span> <span class="fu">vars</span>(<span class="no">math</span>, <span class="no">read</span>, <span class="no">science</span>),
               <span class="kw">.funs</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/list.html">list</a></span>(<span class="kw">wmean</span> <span class="kw">=</span> ~<span class="fu">w_mean</span>(<span class="no">.</span>, <span class="kw">w</span> <span class="kw">=</span> <span class="no">stu_wgt</span>))) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">year</span> <span class="kw">=</span> <span class="no">year</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/base/character.html">as.character</a></span>() <span class="kw">%&gt;%</span> <span class="no">as.integer</span>) <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">country</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="fu">n</span>() <span class="kw">&gt;=</span> <span class="fl">10</span>) <span class="kw">%&gt;%</span>
  <span class="fu">ungroup</span>() <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="fu">contains</span>(<span class="st">"_wmean"</span>),
               <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">"names"</span>,
               <span class="kw">values_to</span> <span class="kw">=</span> <span class="st">"values"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">pivot_wider</span>(<span class="kw">names_from</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"gender"</span>, <span class="st">"names"</span>),
              <span class="kw">values_from</span> <span class="kw">=</span> <span class="st">"values"</span>)

<span class="no">stu_ggap_summ</span> <span class="kw">=</span> <span class="no">stu_gender_summ</span> <span class="kw">%&gt;%</span>
  <span class="kw pkg">dplyr</span><span class="kw ns">::</span><span class="fu"><a href="https://dplyr.tidyverse.org/reference/mutate.html">transmute</a></span>(
    <span class="no">year</span>, <span class="no">country</span>,
    <span class="kw">gap_math_wmean</span> <span class="kw">=</span> <span class="no">female_math_wmean</span> - <span class="no">male_math_wmean</span>,
    <span class="kw">gap_read_wmean</span> <span class="kw">=</span> <span class="no">female_read_wmean</span> - <span class="no">male_read_wmean</span>,
    <span class="kw">gap_science_wmean</span> <span class="kw">=</span> <span class="no">female_science_wmean</span> - <span class="no">male_science_wmean</span>)


<span class="no">stu_ggap_summ_long</span> <span class="kw">=</span> <span class="no">stu_ggap_summ</span> <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="kw">cols</span> <span class="kw">=</span> <span class="fu">contains</span>(<span class="st">"gap"</span>),
               <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">"gap_names"</span>,
               <span class="kw">values_to</span> <span class="kw">=</span> <span class="st">"gap_values"</span>)

<span class="no">stu_ggap_summ_long</span> <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu"><a href="https://rdrr.io/pkg/gghighlight/man/reexports.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">year</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">gap_values</span>)) +
  <span class="fu">geom_point</span>() +
  <span class="fu">geom_line</span>(<span class="fu"><a href="https://rdrr.io/pkg/gghighlight/man/reexports.html">aes</a></span>(<span class="kw">group</span> <span class="kw">=</span> <span class="no">country</span>)) +
  <span class="fu">geom_hline</span>(<span class="kw">yintercept</span> <span class="kw">=</span> <span class="fl">0</span>, <span class="kw">colour</span> <span class="kw">=</span> <span class="st">"red"</span>) +
  <span class="fu">facet_wrap</span>(~<span class="no">gap_names</span>) +
  <span class="fu">labs</span>(<span class="kw">title</span> <span class="kw">=</span> <span class="st">"Avg. gender gaps for countries across subjects and years"</span>,
       <span class="kw">subtitle</span> <span class="kw">=</span> <span class="st">"Gap = avg. female score - avg. male score"</span>)</pre></body></html></div>
<p><img src="exploring_time_files/figure-html/unnamed-chunk-7-1.png" width="768"></p>
<div id="across-all-three-subjects-looks-a-bit-ugly" class="section level3">
<h3 class="hasAnchor">
<a href="#across-all-three-subjects-looks-a-bit-ugly" class="anchor"></a>Across all three subjects (looks a bit ugly)</h3>
<div class="sourceCode" id="cb12"><html><body><pre class="r"><span class="no">stu_ggap_summ_nest</span> <span class="kw">=</span> <span class="no">stu_ggap_summ</span> <span class="kw">%&gt;%</span>
  <span class="fu">pivot_longer</span>(<span class="fu">contains</span>(<span class="st">"_wmean"</span>),
               <span class="kw">names_to</span> <span class="kw">=</span> <span class="st">"names"</span>,
               <span class="kw">values_to</span> <span class="kw">=</span> <span class="st">"values"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">group_by</span>(<span class="no">names</span>) <span class="kw">%&gt;%</span>
  <span class="fu">nest</span>() <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">f_tbl</span> <span class="kw">=</span> <span class="fu">map</span>(<span class="kw">.x</span> <span class="kw">=</span> <span class="no">data</span>,
                     <span class="kw">.f</span> <span class="kw">=</span> ~ <span class="no">.x</span> <span class="kw">%&gt;%</span>
                       <span class="fu"><a href="https://rdrr.io/pkg/brolgar/man/reexports.html">as_tsibble</a></span>(<span class="kw">key</span> <span class="kw">=</span> <span class="no">country</span>, <span class="kw">index</span> <span class="kw">=</span> <span class="no">year</span>) <span class="kw">%&gt;%</span>
                       <span class="fu"><a href="https://rdrr.io/pkg/brolgar/man/reexports.html">features</a></span>(<span class="no">values</span>, <span class="no">feat_brolgar</span>) <span class="kw">%&gt;%</span>
                       <span class="fu"><a href="https://rdrr.io/pkg/brolgar/man/keys_near.html">keys_near</a></span>(<span class="kw">key</span> <span class="kw">=</span> <span class="no">country</span>, <span class="kw">var</span> <span class="kw">=</span> <span class="no">range2</span>)),
         <span class="kw">f_data</span> <span class="kw">=</span> <span class="fu">map2</span>(<span class="kw">.x</span> <span class="kw">=</span> <span class="no">data</span>, <span class="kw">.y</span> <span class="kw">=</span> <span class="no">f_tbl</span>,
                       <span class="kw">.f</span> <span class="kw">=</span> ~ <span class="fu">left_join</span>(<span class="no">.x</span>, <span class="no">.y</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="st">"country"</span>)))

<span class="no">stu_ggap_summ_plotdf</span> <span class="kw">=</span> <span class="no">stu_ggap_summ_nest</span> <span class="kw">%&gt;%</span>
  <span class="fu">select</span>(<span class="no">names</span>, <span class="no">f_data</span>) <span class="kw">%&gt;%</span>
  <span class="fu">unnest</span>(<span class="no">f_data</span>) <span class="kw">%&gt;%</span>
  <span class="fu">left_join</span>(<span class="no">countrycode</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="st">"country"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">label_stats_country</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">stat</span>), <span class="fl">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">stat</span>, <span class="st">":"</span>, <span class="no">country_name</span>)))

<span class="no">stu_ggap_summ_plotdf</span> <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu"><a href="https://rdrr.io/pkg/gghighlight/man/reexports.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">year</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">values</span>)) +
  <span class="fu">geom_line</span>(<span class="fu"><a href="https://rdrr.io/pkg/gghighlight/man/reexports.html">aes</a></span>(<span class="kw">group</span> <span class="kw">=</span> <span class="no">country</span>, <span class="kw">colour</span> <span class="kw">=</span> <span class="no">country</span>)) +
  <span class="fu"><a href="https://rdrr.io/pkg/gghighlight/man/gghighlight.html">gghighlight</a></span>(!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">stat</span>), <span class="kw">label_key</span> <span class="kw">=</span> <span class="no">label_stats_country</span>, <span class="kw">calculate_per_facet</span> <span class="kw">=</span> <span class="fl">TRUE</span>, <span class="kw">keep_scales</span> <span class="kw">=</span> <span class="fl">TRUE</span>) +
  <span class="fu">facet_wrap</span>(~<span class="no">names</span>)</pre></body></html></div>
<p><img src="exploring_time_files/figure-html/unnamed-chunk-8-1.png" width="768"></p>
</div>
<div id="math-only-less-elegant" class="section level3">
<h3 class="hasAnchor">
<a href="#math-only-less-elegant" class="anchor"></a>Math only (less elegant)</h3>
<div class="sourceCode" id="cb13"><html><body><pre class="r"><span class="no">stu_gap_math_near</span> <span class="kw">=</span> <span class="no">stu_ggap_summ</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brolgar/man/reexports.html">as_tsibble</a></span>(<span class="kw">key</span> <span class="kw">=</span> <span class="no">country</span>, <span class="kw">index</span> <span class="kw">=</span> <span class="no">year</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brolgar/man/reexports.html">features</a></span>(<span class="no">gap_math_wmean</span>, <span class="no">feat_brolgar</span>) <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://rdrr.io/pkg/brolgar/man/keys_near.html">keys_near</a></span>(<span class="kw">key</span> <span class="kw">=</span> <span class="no">country</span>, <span class="kw">var</span> <span class="kw">=</span> <span class="no">median</span>)

<span class="no">stu_gap_math_plotdf</span> <span class="kw">=</span> <span class="no">stu_ggap_summ</span> <span class="kw">%&gt;%</span>
  <span class="fu"><a href="https://tsibble.tidyverts.org/reference/reexports.html">as_tibble</a></span>() <span class="kw">%&gt;%</span>
  <span class="fu">left_join</span>(<span class="no">stu_gap_math_near</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="st">"country"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">left_join</span>(<span class="no">countrycode</span>, <span class="kw">by</span> <span class="kw">=</span> <span class="st">"country"</span>) <span class="kw">%&gt;%</span>
  <span class="fu">mutate</span>(<span class="kw">label_stats_country</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/r/base/ifelse.html">ifelse</a></span>(<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">stat</span>), <span class="fl">NA</span>, <span class="fu"><a href="https://rdrr.io/r/base/paste.html">paste0</a></span>(<span class="no">stat</span>, <span class="st">":"</span>, <span class="no">country_name</span>)))

<span class="no">p_math</span> <span class="kw">=</span> <span class="no">stu_gap_math_plotdf</span> <span class="kw">%&gt;%</span>
  <span class="fu">ggplot</span>(<span class="fu"><a href="https://rdrr.io/pkg/gghighlight/man/reexports.html">aes</a></span>(<span class="kw">x</span> <span class="kw">=</span> <span class="no">year</span>, <span class="kw">y</span> <span class="kw">=</span> <span class="no">gap_math_wmean</span>,
             <span class="kw">group</span> <span class="kw">=</span> <span class="no">country</span>, <span class="kw">colour</span> <span class="kw">=</span> <span class="no">stat</span>)) +
  <span class="fu">geom_line</span>() +
  <span class="kw pkg">gghighlight</span><span class="kw ns">::</span><span class="fu"><a href="https://rdrr.io/pkg/gghighlight/man/gghighlight.html">gghighlight</a></span>(!<span class="fu"><a href="https://rdrr.io/r/base/NA.html">is.na</a></span>(<span class="no">stat</span>), <span class="kw">label_key</span> <span class="kw">=</span> <span class="no">label_stats_country</span>)

<span class="no">p_math</span></pre></body></html></div>
<p><img src="exploring_time_files/figure-html/unnamed-chunk-9-1.png" width="768"></p>
<div class="sourceCode" id="cb14"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/base/library.html">library</a></span>(<span class="no">lme4</span>)
<span class="co"># aus_data = student %&gt;% filter(country == "AUS")</span>
<span class="co"># obj = lmer(math ~ gender + (gender|year/school_id), data = student,</span>
<span class="co">#              control = lmerControl(optimizer = "optimx", calc.derivs = FALSE,</span>
<span class="co">#      optCtrl = list(method = "nlminb", starttests = FALSE, kkt = FALSE)))</span>
<span class="co"># </span>
<span class="co"># summary(obj)</span>

<span class="no">sub_stu</span> <span class="kw">=</span> <span class="no">student</span> <span class="kw">%&gt;%</span> <span class="fu"><a href="https://rdrr.io/r/stats/filter.html">filter</a></span>(<span class="no">country</span> <span class="kw">%in%</span> <span class="fu"><a href="https://rdrr.io/r/base/c.html">c</a></span>(<span class="st">"AUS"</span>))

<span class="fu"><a href="https://rdrr.io/r/stats/t.test.html">t.test</a></span>(<span class="no">math</span> ~ <span class="no">gender</span>, <span class="kw">data</span> <span class="kw">=</span> <span class="no">sub_stu</span>)

<span class="no">obj</span> <span class="kw">=</span> <span class="fu"><a href="https://rdrr.io/pkg/lme4/man/lmer.html">lmer</a></span>(<span class="no">math</span> ~ <span class="no">gender</span> + <span class="no">escs</span> + (<span class="no">gender</span> <span class="kw">|</span> <span class="no">year</span>/<span class="no">school_id</span>), <span class="kw">data</span> <span class="kw">=</span> <span class="no">sub_stu</span>)

<span class="fu"><a href="https://rdrr.io/r/base/summary.html">summary</a></span>(<span class="no">obj</span>)

<span class="co"># aus_aug = broom::augment(obj)</span>

<span class="co"># sub_stu = student %&gt;% filter(country %in% c("QAT"))</span>
<span class="co"># </span>
<span class="co"># obj = lmer(math ~ gender + escs + (gender | year/school_id), data = sub_stu)</span>
<span class="co"># </span>
<span class="co"># summary(obj)</span></pre></body></html></div>
</div>
</div>
</div>
<div id="session-info" class="section level1">
<h1 class="hasAnchor">
<a href="#session-info" class="anchor"></a>Session info</h1>
<div class="sourceCode" id="cb15"><html><body><pre class="r"><span class="fu"><a href="https://rdrr.io/r/utils/sessionInfo.html">sessionInfo</a></span>()
<span class="co">#&gt; R version 4.0.0 (2020-04-24)</span>
<span class="co">#&gt; Platform: x86_64-apple-darwin17.0 (64-bit)</span>
<span class="co">#&gt; Running under: macOS Catalina 10.15.5</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; Matrix products: default</span>
<span class="co">#&gt; BLAS:   /Library/Frameworks/R.framework/Versions/4.0/Resources/lib/libRblas.dylib</span>
<span class="co">#&gt; LAPACK: /Library/Frameworks/R.framework/Versions/4.0/Resources/lib/libRlapack.dylib</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; locale:</span>
<span class="co">#&gt; [1] en_US.UTF-8/en_US.UTF-8/en_US.UTF-8/C/en_US.UTF-8/en_US.UTF-8</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; attached base packages:</span>
<span class="co">#&gt; [1] stats     graphics  grDevices utils     datasets  methods   base     </span>
<span class="co">#&gt; </span>
<span class="co">#&gt; other attached packages:</span>
<span class="co">#&gt;  [1] tsibble_0.9.0            ggrepel_0.8.2            gghighlight_0.3.0       </span>
<span class="co">#&gt;  [4] brolgar_0.0.5.9100       patchwork_1.0.0          forcats_0.5.0           </span>
<span class="co">#&gt;  [7] stringr_1.4.0            dplyr_1.0.0              purrr_0.3.4             </span>
<span class="co">#&gt; [10] readr_1.3.1              tidyr_1.1.0              tibble_3.0.1            </span>
<span class="co">#&gt; [13] ggplot2_3.3.1            tidyverse_1.3.0          learningtower_0.0.0.9000</span>
<span class="co">#&gt; </span>
<span class="co">#&gt; loaded via a namespace (and not attached):</span>
<span class="co">#&gt;  [1] Rcpp_1.0.4.6       lubridate_1.7.8    lattice_0.20-41    utf8_1.1.4        </span>
<span class="co">#&gt;  [5] assertthat_0.2.1   rprojroot_1.3-2    digest_0.6.25      R6_2.4.1          </span>
<span class="co">#&gt;  [9] cellranger_1.1.0   backports_1.1.7    reprex_0.3.0       evaluate_0.14     </span>
<span class="co">#&gt; [13] httr_1.4.1         pillar_1.4.4       rlang_0.4.6        readxl_1.3.1      </span>
<span class="co">#&gt; [17] rstudioapi_0.11    blob_1.2.1         rmarkdown_2.2      pkgdown_1.5.1.9000</span>
<span class="co">#&gt; [21] labeling_0.3       desc_1.2.0         fabletools_0.1.3   munsell_0.5.0     </span>
<span class="co">#&gt; [25] broom_0.5.6        anytime_0.3.7      compiler_4.0.0     modelr_0.1.8      </span>
<span class="co">#&gt; [29] xfun_0.14          pkgconfig_2.0.3    htmltools_0.4.0    tidyselect_1.1.0  </span>
<span class="co">#&gt; [33] fansi_0.4.1        crayon_1.3.4       dbplyr_1.4.4       withr_2.2.0       </span>
<span class="co">#&gt; [37] MASS_7.3-51.5      grid_4.0.0         nlme_3.1-147       jsonlite_1.6.1    </span>
<span class="co">#&gt; [41] gtable_0.3.0       lifecycle_0.2.0    DBI_1.1.0          magrittr_1.5      </span>
<span class="co">#&gt; [45] scales_1.1.1       cli_2.0.2          stringi_1.4.6      farver_2.0.3      </span>
<span class="co">#&gt; [49] fs_1.4.1           xml2_1.3.2         ellipsis_0.3.1     generics_0.0.2    </span>
<span class="co">#&gt; [53] vctrs_0.3.0        RColorBrewer_1.1-2 tools_4.0.0        glue_1.4.1        </span>
<span class="co">#&gt; [57] hms_0.5.3          yaml_2.2.1         colorspace_1.4-1   rvest_0.3.5       </span>
<span class="co">#&gt; [61] memoise_1.1.0      knitr_1.28         haven_2.3.1</span></pre></body></html></div>
</div>
  </div>

  <div class="col-md-3 hidden-xs hidden-sm" id="pkgdown-sidebar">

        <nav id="toc" data-toggle="toc"><h2 data-toc-skip>Contents</h2>
    </nav>
</div>

</div>



      <footer><div class="copyright">
  <p>Developed by Kim Fitter, Paul Yacobellis, Erika Siregar, Sarah Romanes, Kevin Wang, Giulio Valentino Dalla Riva, Dianne Cook, Nick Tierney.</p>
</div>

<div class="pkgdown">
  <p>Site built with <a href="https://pkgdown.r-lib.org/">pkgdown</a> 1.5.1.9000.</p>
</div>

      </footer>
</div>

  


  </body>
</html>
